name: Mint Symbolic OP_RETURN + PSBT

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'data/VDL_v1.44g_manifest.json'
      - 'mint_symbolic_payloads.py'
      - 'mint_psbt_symbolic.py'
      - 'make_qr.py'
  workflow_dispatch:
    inputs:
      commit_artifacts:
        description: 'Commit generated artifacts back to the repo'
        required: false
        type: boolean
        default: false

jobs:
  mint_and_verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install "qrcode[pil]"

      - name: Validate Manifest
        id: validate_manifest
        run: |
          if [ ! -f "data/VDL_v1.44g_manifest.json" ]; then
            echo "::error::Manifest file not found at data/VDL_v1.44g_manifest.json"
            exit 1
          fi
          echo "Manifest found."

      - name: Mint Symbolic Payloads
        id: mint_payloads
        run: python3 mint_symbolic_payloads.py

      - name: Create PSBT Skeleton
        id: mint_psbt
        run: python3 mint_psbt_symbolic.py

      - name: Generate QR Code
        id: make_qr
        run: python3 make_qr.py

      - name: Sanity Check Payload Length
        id: sanity_check
        run: |
          HEX_PAYLOAD=$(cat data/VDL_v1.44g_OP_RETURN.symbolic.hex | tr -d '[:space:]')
          BYTE_COUNT=$(( ${#HEX_PAYLOAD} / 2 ))
          if [ "$BYTE_COUNT" -ne 80 ]; then
            echo "::error::Invalid OP_RETURN length: expected 80 bytes, got $BYTE_COUNT bytes."
            exit 1
          fi
          echo "Payload length is correct (80 bytes)."
          echo "ScriptPubKey Preview: 6a50${HEX_PAYLOAD:0:64}..."

      - name: Upload Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: symbolic-op-return-artifacts
          path: |
            data/VDL_v1.44g_OP_RETURN.symbolic.hex
            data/VDL_v1.44g_OP_RETURN.symbolic.bin
            data/VDL_v1.44g_OP25_RETURN.symbolic.hex
            data/VDL_v1.44g_OP25_RETURN.symbolic.bin
            data/OP_RETURN.symbolic.base43.txt
            data/OP_RETURN.symbolic.asm.txt
            data/OP_RETURN.symbolic.scriptpubkey.hex
            data/tx_skeleton_psbt.json
            data/OP_RETURN_symbolic_QR.png

      - name: Commit Artifacts (if enabled)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.commit_artifacts == 'true' }}
        run: |
          git config --global user.name 'VALORAI Guardian'
          git config --global user.email 'guardian@valorchain.io'
          git add data/*.hex data/*.bin data/*.txt data/*.json data/*.png
          git commit -m "chore: Update symbolic OP_RETURN artifacts" || echo "No changes to commit"
          git push
